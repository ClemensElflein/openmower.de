name: GitHub Pages

on:
  push:
    branches:
      - main
    tags:
      - 'v*'

env:
  main_branch: main
  base_url: 'https://openmower.de/'

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive  # Fetch the Docsy theme
          fetch-depth: 0         # Fetch all history for .GitInfo and .Lastmod

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: '0.111.3'
          extended: true

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      - run: npm install
      - run: scripts/gen-doc-versions.sh

      # Build for main (full site, version "latest", baseURL /latest/)
      - name: Build Hugo (main)
        if: github.ref == 'refs/heads/main'
        run: |
          cat > config/_ci_override.toml << EOF
          baseURL = "${{ env.base_url }}latest/"
          [params]
          version = "latest"
          EOF

          hugo --minify --config config.toml,config/_generated_versions.toml,config/_ci_override.toml

      # Build for tags (docs-only environment, version = tag, baseURL /archive/<tag>/)
      - name: Build Hugo (tag)
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          cat > config/_ci_override.toml << EOF
          baseURL = "${{ env.base_url }}archive/${{ github.ref_name }}/"
          [params]
          version = "${{ github.ref_name }}"
          archived_version = true
          EOF

          hugo --minify --environment docs-only --config config.toml,config/_generated_versions.toml,config/_ci_override.toml

      - name: Debug
        run: cat config/_ci_override.toml && cat config/_generated_versions.toml

      # Deploy main build to /latest
      - name: Deploy latest (main)
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          destination_dir: latest

      # Deploy tag builds to /archive/<tag>
      - name: Deploy archive (tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          destination_dir: archive/${{ github.ref_name }}

      # Prepare a root index.html that is just the Hugo-generated homepage
      - name: Prepare root index
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p public-root
          cp public/index.html public-root/index.html

      # Deploy root index and CNAME, keeping /latest and /archive/*
      - name: Deploy root index and CNAME
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public-root
          keep_files: true
          cname: openmower.de
